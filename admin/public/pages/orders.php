<?php
session_start();
include "../../backend/db_connection.php";
include "../../backend/check_role.php"; 
// Assuming checkRole('Orders'); is called if needed, or handled by sidebar/main access control

$sort_column = $_GET['sort'] ?? 'id';
$sort_direction = $_GET['direction'] ?? 'DESC';
$allowed_columns = ['id', 'po_number', 'order_type', 'username', 'company', 'order_date', 'delivery_date', 'progress', 'total_amount', 'status'];
if (!in_array($sort_column, $allowed_columns)) { $sort_column = 'id'; }
if ($sort_direction !== 'ASC' && $sort_direction !== 'DESC') { $sort_direction = 'DESC'; }

function isValidDeliveryDayPHP($date_str) { if (empty($date_str)) return false; try { $date = new DateTime($date_str); $dayOfWeek = $date->format('N'); return ($dayOfWeek == 1 || $dayOfWeek == 3 || $dayOfWeek == 5); } catch (Exception $e) { return false; } }
function isValidDeliveryGapPHP($orderDate_str, $deliveryDate_str, $minDays = 5) { if (empty($orderDate_str) || empty($deliveryDate_str)) return false; try { $orderDateTime = new DateTime($orderDate_str); $deliveryDateTime = new DateTime($deliveryDate_str); $minDeliveryDateTime = clone $orderDateTime; $minDeliveryDateTime->modify("+{$minDays} days"); return $deliveryDateTime >= $minDeliveryDateTime; } catch (Exception $e) { return false; } }

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['update_delivery_date']) && isset($_POST['po_number']) && isset($_POST['new_delivery_date'])) {
    $po_number_update = $_POST['po_number']; $new_delivery_date_update = $_POST['new_delivery_date'];
    $stmt_get_order_for_date = $conn->prepare("SELECT order_date, username FROM orders WHERE po_number = ?"); $stmt_get_order_for_date->bind_param("s", $po_number_update); $stmt_get_order_for_date->execute(); $result_get_order_for_date = $stmt_get_order_for_date->get_result(); $order_for_date_update = $result_get_order_for_date->fetch_assoc(); $stmt_get_order_for_date->close();
    if ($order_for_date_update) {
        if (isValidDeliveryDayPHP($new_delivery_date_update) && isValidDeliveryGapPHP($order_for_date_update['order_date'], $new_delivery_date_update, 5)) {
            $stmt_update_date = $conn->prepare("UPDATE orders SET delivery_date = ? WHERE po_number = ?"); $stmt_update_date->bind_param("ss", $new_delivery_date_update, $po_number_update);
            if ($stmt_update_date->execute()) { $_SESSION['message'] = "Delivery date updated for PO: " . htmlspecialchars($po_number_update); $_SESSION['message_type'] = "success"; /* Add email logic if needed */ } else { $_SESSION['message'] = "Error updating delivery date."; $_SESSION['message_type'] = "error"; }
            $stmt_update_date->close();
        } else { $_SESSION['message'] = !isValidDeliveryDayPHP($new_delivery_date_update) ? "Delivery must be Mon, Wed, or Fri." : "Delivery must be at least 5 days after order date."; $_SESSION['message_type'] = "error"; }
    } else { $_SESSION['message'] = "Order not found for PO: " . htmlspecialchars($po_number_update); $_SESSION['message_type'] = "error"; }
    header("Location: orders.php" . (isset($_GET['sort']) ? "?sort=".htmlspecialchars($_GET['sort'])."&direction=".htmlspecialchars($_GET['direction']) : "")); exit();
}

$clients_list = []; $clients_data_map = [];
$stmt_clients = $conn->prepare("SELECT username, company_address, company, email FROM clients_accounts WHERE status = 'active' ORDER BY username ASC"); if ($stmt_clients) { $stmt_clients->execute(); $result_clients = $stmt_clients->get_result(); while ($row_client = $result_clients->fetch_assoc()) { $clients_list[] = $row_client['username']; $clients_data_map[$row_client['username']] = ['company' => $row_client['company'], 'company_address' => $row_client['company_address'], 'email' => $row_client['email']]; } $stmt_clients->close(); } else { error_log("Failed to prepare client statement: " . $conn->error); }

$orders_list = [];
$sql_orders = "SELECT o.id, o.po_number, o.order_type, o.username, o.company, o.order_date, o.delivery_date, o.delivery_address, o.orders, o.total_amount, o.status, o.progress, o.special_instructions, o.payment_method, o.payment_status FROM orders o ORDER BY {$conn->real_escape_string($sort_column)} {$conn->real_escape_string($sort_direction)}";
$stmt_orders = $conn->prepare($sql_orders); if ($stmt_orders) { $stmt_orders->execute(); $result_orders = $stmt_orders->get_result(); if ($result_orders) { while ($row_order = $result_orders->fetch_assoc()) { $orders_list[] = $row_order; } } $stmt_orders->close(); } else { error_log("Failed to prepare orders statement: " . $conn->error); }

function getSortUrl($column_name, $current_sort_column, $current_sort_direction) { $new_direction = ($column_name === $current_sort_column && $current_sort_direction === 'ASC') ? 'DESC' : 'ASC'; return "?" . http_build_query(['sort' => $column_name, 'direction' => $new_direction]); }
function getSortIcon($column_name, $current_sort_column, $current_sort_direction) { if ($column_name === $current_sort_column) { return ($current_sort_direction === 'ASC') ? '<i class="fas fa-sort-up"></i>' : '<i class="fas fa-sort-down"></i>'; } return '<i class="fas fa-sort"></i>'; }
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Manage Orders - Top Exchange</title>
    <link rel="stylesheet" href="/css/orders.css"> <link rel="stylesheet" href="/css/sidebar.css"> <link rel="stylesheet" href="/css/toast.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style> /* All your existing CSS styles from the previous full version */ </style>
</head>
<body>
    <?php include '../sidebar.php'; ?>
    <div class="main-content">
        <?php if (isset($_SESSION['message'])): ?>
            <div class="alert alert-<?php echo htmlspecialchars($_SESSION['message_type']); ?>"><?php echo htmlspecialchars($_SESSION['message']); ?></div>
            <?php unset($_SESSION['message']); unset($_SESSION['message_type']); ?>
        <?php endif; ?>
        
        <div class="orders-header"><h1>Manage Orders</h1><div class="search-container"><input type="text" id="searchInput" placeholder="Search..."><button class="search-btn"><i class="fas fa-search"></i></button></div><button onclick="openAddOrderForm()" class="add-order-btn"><i class="fas fa-plus"></i> Add New Order</button></div>
        <div class="orders-table-container">
            <table class="orders-table">
                <thead><tr>
                    <th class="sortable"><a href="<?= getSortUrl('po_number', $sort_column, $sort_direction) ?>">PO Number <?= getSortIcon('po_number', $sort_column, $sort_direction) ?></a></th>
                    <th class="sortable"><a href="<?= getSortUrl('order_type', $sort_column, $sort_direction) ?>">Order Type <?= getSortIcon('order_type', $sort_column, $sort_direction) ?></a></th>
                    <th class="sortable"><a href="<?= getSortUrl('username', $sort_column, $sort_direction) ?>">Username <?= getSortIcon('username', $sort_column, $sort_direction) ?></a></th>
                    <th class="sortable"><a href="<?= getSortUrl('company', $sort_column, $sort_direction) ?>">Company <?= getSortIcon('company', $sort_column, $sort_direction) ?></a></th>
                    <th class="sortable"><a href="<?= getSortUrl('order_date', $sort_column, $sort_direction) ?>">Order Date <?= getSortIcon('order_date', $sort_column, $sort_direction) ?></a></th>
                    <th class="sortable"><a href="<?= getSortUrl('delivery_date', $sort_column, $sort_direction) ?>">Delivery Date <?= getSortIcon('delivery_date', $sort_column, $sort_direction) ?></a></th>
                    <th class="sortable"><a href="<?= getSortUrl('progress', $sort_column, $sort_direction) ?>">Progress <?= getSortIcon('progress', $sort_column, $sort_direction) ?></a></th>
                    <th>Items</th>
                    <th class="sortable"><a href="<?= getSortUrl('total_amount', $sort_column, $sort_direction) ?>">Total Amount <?= getSortIcon('total_amount', $sort_column, $sort_direction) ?></a></th>
                    <th>Instructions</th>
                    <th class="sortable"><a href="<?= getSortUrl('status', $sort_column, $sort_direction) ?>">Status <?= getSortIcon('status', $sort_column, $sort_direction) ?></a></th>
                    <th>Actions</th>
                </tr></thead>
                <tbody>
                    <?php if (count($orders_list) > 0): foreach ($orders_list as $order_item): ?>
                        <tr data-current-status="<?= htmlspecialchars($order_item['status']) ?>" data-po-number="<?= htmlspecialchars($order_item['po_number']) ?>">
                            <td><?= htmlspecialchars($order_item['po_number']) ?></td>
                            <td><?= htmlspecialchars($order_item['order_type'] ?? 'N/A') ?></td>
                            <td><?= htmlspecialchars($order_item['username'] ?? 'N/A') ?></td>
                            <td><?= htmlspecialchars($order_item['company'] ?? ($clients_data_map[$order_item['username']]['company'] ?? 'N/A')) ?></td>
                            <td><?= htmlspecialchars(date("M d, Y", strtotime($order_item['order_date']))) ?></td>
                            <td>
                                <?php if ($order_item['order_type'] === 'Walk In' && $order_item['order_date'] === $order_item['delivery_date']) { echo 'N/A (Walk-In)'; } elseif (empty($order_item['delivery_date'])) { echo 'N/A'; } else { echo htmlspecialchars(date("M d, Y", strtotime($order_item['delivery_date']))); }?>
                                <?php if ($order_item['order_type'] !== 'Walk In' && !empty($order_item['delivery_date'])): ?><button class="edit-date-btn" onclick="openEditDateModal('<?= htmlspecialchars($order_item['po_number']) ?>', '<?= htmlspecialchars($order_item['delivery_date']) ?>', '<?= htmlspecialchars($order_item['order_date']) ?>')"><i class="fas fa-edit"></i></button><?php endif; ?>
                            </td>
                            <td><?php if (in_array($order_item['status'], ['Active', 'For Delivery', 'Completed'])): ?><div class="progress-bar-container"><div class="progress-bar" style="width: <?= $order_item['progress'] ?? 0 ?>%"></div><div class="progress-text"><?= $order_item['progress'] ?? 0 ?>%</div></div><?php else: ?><span class="status-badge status-<?= strtolower(htmlspecialchars($order_item['status'])) ?>"><?= htmlspecialchars($order_item['status']) ?></span><?php endif; ?></td>
                            <td><?php if ($order_item['status'] === 'Active'): ?><button class="view-orders-btn" onclick="viewOrderDetails('<?= htmlspecialchars($order_item['po_number']) ?>')"><i class="fas fa-tasks"></i> Manage Items</button><?php else: ?><button class="view-orders-btn" onclick="viewOrderInfo('<?= htmlspecialchars(addslashes($order_item['orders'])) ?>', '<?= htmlspecialchars($order_item['status']) ?>', '<?= htmlspecialchars($order_item['po_number']) ?>')"><i class="fas fa-eye"></i> View Items</button><?php endif; ?></td>
                            <td>PHP <?= htmlspecialchars(number_format($order_item['total_amount'], 2)) ?></td>
                            <td><?php if (!empty($order_item['special_instructions'])): ?><button class="instructions-btn" onclick="viewSpecialInstructions('<?= htmlspecialchars(addslashes($order_item['po_number'])) ?>', '<?= htmlspecialchars(addslashes($order_item['special_instructions'])) ?>')"><i class="fas fa-comment-alt"></i> View</button><?php else: ?><span class="no-instructions">None</span><?php endif; ?></td>
                            <td><span class="status-badge status-<?= strtolower(htmlspecialchars($order_item['status'])) ?>"><?= htmlspecialchars($order_item['status']) ?></span></td>
                            <td class="action-buttons">
                                <?php if ($order_item['status'] === 'Pending'): ?><button class="status-btn" onclick="confirmPendingStatusChange('<?= htmlspecialchars($order_item['po_number']) ?>', '<?= htmlspecialchars($order_item['username'] ?? 'Walk-In') ?>', '<?= htmlspecialchars(addslashes($order_item['orders'])) ?>', 'Pending')"><i class="fas fa-cogs"></i> Manage</button>
                                <?php elseif ($order_item['status'] === 'Active' && ($order_item['progress'] ?? 0) < 100): ?><button class="status-btn" onclick="confirmStatusChange('<?= htmlspecialchars($order_item['po_number']) ?>', '<?= htmlspecialchars($order_item['username'] ?? 'Walk-In') ?>', 'Active')"><i class="fas fa-sync-alt"></i> Update</button>
                                <?php elseif ($order_item['status'] === 'Rejected'): ?><button class="status-btn" onclick="confirmRejectedStatusChange('<?= htmlspecialchars($order_item['po_number']) ?>', '<?= htmlspecialchars($order_item['username'] ?? 'Walk-In') ?>', 'Rejected')"><i class="fas fa-undo"></i> Review</button><?php endif; ?>
                                <button class="download-btn" onclick="prepareAndShowPOPreview('<?= htmlspecialchars($order_item['po_number']) ?>', '<?= htmlspecialchars($order_item['username'] ?? 'Walk-In') ?>', '<?= htmlspecialchars($order_item['company'] ?? ($clients_data_map[$order_item['username']]['company'] ?? 'N/A')) ?>', '<?= htmlspecialchars($order_item['order_date']) ?>', '<?= htmlspecialchars($order_item['delivery_date'] ?? '') ?>', '<?= htmlspecialchars($order_item['delivery_address']) ?>', '<?= htmlspecialchars(addslashes($order_item['orders'])) ?>', '<?= htmlspecialchars($order_item['total_amount']) ?>', '<?= htmlspecialchars(addslashes($order_item['special_instructions'] ?? '')) ?>', '<?= htmlspecialchars($order_item['order_type']) ?>')"><i class="fas fa-file-pdf"></i> Invoice</button>
                            </td>
                        </tr>
                    <?php endforeach; else: ?><tr><td colspan="12" class="no-orders">No orders found.</td></tr><?php endif; ?>
                </tbody>
            </table>
        </div>
    </div>
    <div class="toast-container" id="toast-container"></div>
    <div id="pdfPreview"><div class="pdf-container"><button class="close-pdf" onclick="closePDFPreview()"><i class="fas fa-times"></i></button><div id="contentToDownload"></div><div class="pdf-actions"><button class="download-pdf-btn" onclick="downloadCurrentPODataAsPDF()"><i class="fas fa-download"></i> Download PDF</button></div></div></div>
    <div id="specialInstructionsModal" class="instructions-modal"><div class="instructions-modal-content"><div class="instructions-header"><h3>Special Instructions</h3><button class="close-instructions-btn" onclick="closeSpecialInstructions()" style="background:none;border:none;color:white;font-size:1.2em;padding:0;">&times;</button></div><div class="instructions-body" id="instructionsContent"></div><div class="instructions-footer"><button class="close-instructions-btn" onclick="closeSpecialInstructions()">Close</button></div></div></div>
    <div id="orderDetailsModal" class="overlay"> <div class="overlay-content"> <!-- ... Order Details Modal Content ... --> </div> </div>
    <div id="statusModal" class="modal"><div class="modal-content"><h2>Change Order Status</h2><p id="statusMessage"></p><div class="status-buttons"><button onclick="confirmStatusAction('Pending')" class="modal-status-btn pending"><i class="fas fa-clock"></i> Set to Pending</button><button onclick="confirmStatusAction('Rejected')" class="modal-status-btn rejected"><i class="fas fa-times-circle"></i> Set to Rejected</button></div><div class="modal-footer"><button type="button" onclick="closeStatusModal()" class="modal-cancel-btn">Cancel</button></div></div></div>
    <div id="rejectedStatusModal" class="modal"><div class="modal-content"><h2>Change Rejected Order Status</h2><p id="rejectedStatusMessage"></p><div class="status-buttons"><button onclick="confirmStatusAction('Pending')" class="modal-status-btn pending"><i class="fas fa-clock"></i> Set to Pending</button></div><div class="modal-footer"><button type="button" onclick="closeRejectedStatusModal()" class="modal-cancel-btn">Cancel</button></div></div></div>
    <div id="pendingStatusModal" class="modal"><div class="modal-content"><h2>Change Pending Order Status</h2><p id="pendingStatusMessage"></p><div id="rawMaterialsContainerPending" class="raw-materials-container" style="margin-top:15px;"></div><div class="status-buttons"><button id="activeStatusBtnPending" onclick="confirmStatusAction('Active')" class="modal-status-btn active" disabled><i class="fas fa-check-circle"></i> Set to Active</button><button onclick="confirmStatusAction('Rejected')" class="modal-status-btn rejected"><i class="fas fa-times-circle"></i> Set to Rejected</button></div><div class="modal-footer"><button type="button" onclick="closePendingStatusModal()" class="modal-cancel-btn">Cancel</button></div></div></div>
    <div id="editDateModal" class="modal"> <!-- ... Edit Date Modal Content ... --> </div>
    <div id="addOrderOverlay" class="overlay"> <div class="overlay-content"><div class="overlay-header"><h2 class="overlay-title"><i class="fas fa-cart-plus"></i> Create New Order</h2></div><form id="addOrderForm" method="POST" class="order-form"> <!-- ... Add Order Form Content ... --> </form></div></div>
    <div id="addConfirmationModal" class="confirmation-modal"> <!-- ... Add Confirmation Modal Content ... --> </div>
    <div id="saveProgressConfirmationModal" class="confirmation-modal"> <!-- ... Save Progress Modal ... --> </div>
    <div id="statusConfirmationModal" class="confirmation-modal"><div class="confirmation-content"><div class="confirmation-title">Confirm Status Change</div><div class="confirmation-message" id="statusConfirmationMessage"></div><div class="confirmation-buttons"><button class="confirm-no" onclick="closeStatusConfirmation()">No</button><button class="confirm-yes" onclick="executeStatusChange()">Yes, Confirm</button></div></div></div>
    <div id="inventoryOverlay" class="overlay"> <!-- ... Inventory Modal Content ... --> </div>
    <div id="cartModal" class="overlay"> <!-- ... Cart Modal Content ... --> </div>

    <script>
        let currentPoNumber = '';
        let currentOrderOriginalStatus = '';
        let currentOrderItemsData = []; // For item progress management
        let currentPODataForPDF = null; // For PDF preview/download
        let currentSelectedStatus = ''; // For status change confirmation flow
        const clientsDataFromPHP = <?php echo json_encode($clients_data_map); ?>;
        let currentCartItems = []; // For new order creation

        function showToast(message, type = 'info', duration = 3000) { const tc=document.getElementById('toast-container'); if(!tc)return; const t=document.createElement('div'); t.className=`toast ${type}`; let i='fa-info-circle'; if(type==='success')i='fa-check-circle'; else if(type==='error')i='fa-times-circle'; else if(type==='warning')i='fa-exclamation-triangle'; t.innerHTML=`<div class="toast-content"><i class="fas ${i}"></i><div class="message">${message}</div></div>`; tc.appendChild(t); setTimeout(()=>{t.style.opacity='0';setTimeout(()=>t.remove(),300)},duration); }
        function formatWeight(weightInGrams) { if(isNaN(parseFloat(weightInGrams)))return '0 g'; if(weightInGrams>=1000)return(weightInGrams/1000).toFixed(2).replace(/\.00$/,'')+' kg'; return(parseFloat(weightInGrams).toFixed(2).replace(/\.00$/,''))+' g'; }
        function isValidDeliveryDay(d){if(!d)return false;try{const dt=new Date(d+'T00:00:00');const day=dt.getDay();return(day===1||day===3||day===5);}catch(e){return false;}}
        function isValidDeliveryGap(o,d,m=5){if(!o||!d)return false;try{const odt=new Date(o+'T00:00:00');const ddt=new Date(d+'T00:00:00');const mdt=new Date(odt);mdt.setDate(odt.getDate()+m);mdt.setHours(0,0,0,0);ddt.setHours(0,0,0,0);return ddt>=mdt;}catch(e){return false;}}
        function getNextAvailableDeliveryDate(b=null,a=5){let s;if(b){s=new Date(b.includes('T')?b:b+'T00:00:00');}else{s=new Date();s.setHours(0,0,0,0);}s.setDate(s.getDate()+a);while(true){const day=s.getDay();if(day===1||day===3||day===5)break;s.setDate(s.getDate()+1);}const y=s.getFullYear();const m=(s.getMonth()+1).toString().padStart(2,'0');const d=s.getDate().toString().padStart(2,'0');return`${y}-${m}-${d}`;}

        function prepareAndShowPOPreview(po,user,comp,oDate,dDate,dAddr,ordersJSON,total,instr,oType){currentPODataForPDF={poNumber:po,username:user,company:comp,orderDate:oDate,deliveryDate:dDate,deliveryAddress:dAddr,ordersJsonString:ordersJSON,totalAmount:total,specialInstructions:instr,orderType:oType};try{$('#printCompany').text(comp||'N/A');$('#printPoNumber').text(po);$('#printUsername').text(user+(comp&&comp!=='N/A'?` (${comp})`:''));let dispAddr=dAddr;if(oType==='Walk In'&&dAddr===comp){dispAddr='N/A (Walk-In)';}$('#printDeliveryAddress').text(dispAddr||'N/A');$('#printOrderDate').text(oDate?new Date(oDate+'T00:00:00').toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}):'N/A');if(oType==='Walk In'||!dDate||oDate===dDate){$('#printDeliveryDateRow').hide();}else{$('#printDeliveryDate').text(new Date(dDate+'T00:00:00').toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}));$('#printDeliveryDateRow').show();}const iSec=$('#printInstructionsSection');const iCont=$('#printSpecialInstructions');if(instr&&instr.trim()){iCont.html(instr.replace(/\n/g,'<br>'));iSec.show();}else{iSec.hide();}const itemsArr=JSON.parse(ordersJSON);const itemsBody=$('#printOrderItems').empty();if(itemsArr&&itemsArr.length>0){itemsArr.forEach(i=>{const it=(parseFloat(i.price)||0)*(parseInt(i.quantity)||0);itemsBody.append(`<tr><td>${i.category||'N/A'}</td><td>${i.item_description||'N/A'}</td><td>${i.packaging||'N/A'}</td><td style="text-align:right;">${i.quantity||0}</td><td style="text-align:right;">${(parseFloat(i.price)||0).toFixed(2)}</td><td style="text-align:right;">${it.toFixed(2)}</td></tr>`);});}else{itemsBody.append('<tr><td colspan="6" style="text-align:center;">No items.</td></tr>');}$('#printTotalAmount').text(parseFloat(total).toFixed(2));$('#pdfPreview').show();}catch(e){showToast('Error preparing PO preview: '+e.message,'error');currentPODataForPDF=null;closePDFPreview();}}
        function downloadCurrentPODataAsPDF(){if(!currentPODataForPDF){showToast('No PO data to download.','error');return;}const el=document.getElementById('contentToDownload');const opts={margin:[10,8,10,8],filename:`SalesInvoice_${currentPODataForPDF.poNumber}.pdf`,image:{type:'jpeg',quality:0.95},html2canvas:{scale:2,useCORS:true,logging:false},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};const btn=$('.download-pdf-btn');const origTxt=btn.html();btn.html('<i class="fas fa-spinner fa-spin"></i> Generating...').prop('disabled',true);html2pdf().set(opts).from(el).save().then(()=>{showToast(`Invoice for PO ${currentPODataForPDF.poNumber} downloaded.`,'success');}).catch(err=>{showToast('Error generating PDF: '+err.message,'error');}).finally(()=>{btn.html(origTxt).prop('disabled',false);});}
        function closePDFPreview(){$('#pdfPreview').hide();currentPODataForPDF=null;}

        function confirmStatusChange(po,user,origStat){currentPoNumber=po;currentOrderOriginalStatus=origStat;$('#statusMessage').text(`Change status for PO ${po}? Current: ${origStat}.`);$('#statusModal').show();}
        function confirmRejectedStatusChange(po,user,origStat){currentPoNumber=po;currentOrderOriginalStatus=origStat;$('#rejectedStatusMessage').text(`Order ${po} is Rejected. Change status?`);$('#rejectedStatusModal').show();}
        function confirmPendingStatusChange(po,user,ordersJSON,origStat){currentPoNumber=po;currentOrderOriginalStatus=origStat;$('#pendingStatusMessage').text(`Order ${po} is Pending. Review raw materials:`);const cont=$('#rawMaterialsContainerPending');cont.html('<p style="text-align:center;padding:10px;"><i class="fas fa-spinner fa-spin"></i> Loading raw material status...</p>');$('#activeStatusBtnPending').prop('disabled',true);$('#pendingStatusModal').show();$.ajax({url:'/backend/check_raw_materials.php',type:'POST',data:{orders:ordersJSON,po_number:po},dataType:'json',success:r=>{if(r&&r.success){displayRawMaterialsForPendingModal(r.materials,'#rawMaterialsContainerPending');$('#activeStatusBtnPending').prop('disabled',!r.all_sufficient);if(!r.all_sufficient){let m=Object.entries(r.materials).filter(([n,d])=>!d.sufficient).map(([n,d])=>`${n} (short by ${formatWeight(d.shortfall)})`).join(', ');showToast(`Cannot activate: Insufficient raw materials. Missing: ${m}`,'warning',6000);}}else{cont.html(`<h3 style='color:red;'>Raw Material Check Failed</h3><p style="color:red;">${r.message||'Could not verify.'}</p>`);$('#activeStatusBtnPending').prop('disabled',true);}},error:xhr=>{cont.html(`<h3 style='color:red;'>Server Error</h3><p style="color:red;">Could not check materials. ${xhr.statusText||''}</p>`);$('#activeStatusBtnPending').prop('disabled',true);}}); }
        function displayRawMaterialsForPendingModal(mats,sel){const cont=$(sel);if(!cont.length)return;let h='<h4>Raw Material Stock Check:</h4>';if(!mats||Object.keys(mats).length===0){cont.html(h+'<p class="text-muted">No raw materials required or info unavailable.</p>');return;}h+=`<table class="materials-table"><thead><tr><th>Material</th><th style="text-align:right;">Available</th><th style="text-align:right;">Required</th><th>Status</th></tr></thead><tbody>`;let allS=true;Object.entries(mats).forEach(([name,d])=>{h+=`<tr><td>${name}</td><td style="text-align:right;">${formatWeight(d.available)}</td><td style="text-align:right;">${formatWeight(d.required)}</td><td class="${d.sufficient?'material-sufficient':'material-insufficient'}">${d.sufficient?'<i class="fas fa-check-circle"></i> Sufficient':'<i class="fas fa-times-circle"></i> Insufficient'}</td></tr>`;if(!d.sufficient)allS=false;});h+=`</tbody></table>`;const oMsg=allS?'All raw materials are sufficient.':'Some raw materials are insufficient.';h+=`<p class="materials-status ${allS?'status-sufficient':'status-insufficient'}" style="margin-top:10px;">${oMsg}</p>`;cont.html(h);}
        function confirmStatusAction(newStat){currentSelectedStatus=newStat;let msg=`Change order status to "${newStat}"?`;$('#statusConfirmationMessage').text(msg);$('#statusConfirmationModal').show();$('#statusModal,#pendingStatusModal,#rejectedStatusModal').hide();}
        function closeStatusConfirmation(){$('#statusConfirmationModal').hide();if(currentOrderOriginalStatus==='Pending')$('#pendingStatusModal').show();else if(currentOrderOriginalStatus==='Rejected')$('#rejectedStatusModal').show();else if(currentOrderOriginalStatus==='Active')$('#statusModal').show();currentSelectedStatus='';}
        function executeStatusChange(){$('#statusConfirmationModal').hide();updateOrderStatus(currentSelectedStatus);}
        function updateOrderStatus(newStat){const fd=new FormData();fd.append('po_number',currentPoNumber);fd.append('status',newStat);if(newStat==='Active'&&currentOrderOriginalStatus==='Pending'){fd.append('manage_raw_materials','deduct');}else if((newStat==='Pending'||newStat==='Rejected')&&currentOrderOriginalStatus==='Active'){fd.append('manage_raw_materials','return');}if(newStat==='For Delivery'||newStat==='Completed'){fd.append('progress','100');}fetch('/backend/update_order_status.php',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{if(d.success){let sMsg=`Order status updated to "${newStat}".`;if(d.material_message)sMsg+=` ${d.material_message}`;showToast(sMsg,'success',4000);sendStatusNotificationEmail(currentPoNumber,newStat);setTimeout(()=>window.location.reload(),1800);}else{throw new Error(d.message||'Unknown error updating status.');}}).catch(e=>{showToast(`Error updating status: ${e.message}`,'error',5000);}).finally(()=>{closeRelevantStatusModals();currentPoNumber='';currentOrderOriginalStatus='';currentSelectedStatus='';});}
        function sendStatusNotificationEmail(po,newStat){fetch('/backend/send_status_notification.php',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:`po_number=${encodeURIComponent(po)}&new_status=${encodeURIComponent(newStat)}`}).then(r=>r.json()).then(d=>{console.log(d.success?"Notification sent.":"Notification failed: "+d.message);}).catch(e=>console.error("Email AJAX error:",e));}
        function closeStatusModal(){$('#statusModal').hide();} function closeRejectedStatusModal(){$('#rejectedStatusModal').hide();} function closePendingStatusModal(){$('#pendingStatusModal').hide();$('#rawMaterialsContainerPending').html('');$('#activeStatusBtnPending').prop('disabled',true);} function closeRelevantStatusModals(){closeStatusModal();closePendingStatusModal();closeRejectedStatusModal();}
        
        function viewOrderDetails(po){currentPoNumber=po;$('#orderDetailsModal .overlay-title').html(`<i class="fas fa-tasks"></i> Manage Order Items - PO: ${po}`);fetch(`/backend/get_order_details.php?po_number=${encodeURIComponent(po)}`).then(r=>r.json()).then(d=>{if(d.success){currentOrderItemsData=d.orderItems||[];let completedItemsIndices=d.completedItems||[];let itemQuantityProgressData=d.quantity_progress_data||{};let itemProgressPercentagesMap=d.item_progress_percentages||{};let currentOverallProgress=d.overall_progress||0;$('#orderStatusView').text(d.order_status||'Active');const b=$('#orderDetailsBody').empty();$('#status-header-cell').show();const totalItems=currentOrderItemsData.length;let itemContributionsToOverall={};let calcOverallProgress=0;if(totalItems===0){b.html('<tr><td colspan="6" style="text-align:center;padding:20px;">No items.</td></tr>');$('#overall-progress-info, .save-progress-btn').hide();$('#orderTotalAmount').text('Total: PHP 0.00');$('#orderDetailsModal').show();return;}currentOrderItemsData.forEach((item,idx)=>{const qty=parseInt(item.quantity)||0;const contrib=totalItems>0?(100/totalItems):0;itemContributionsToOverall[idx]=contrib;let unitsDone=0;if(itemQuantityProgressData[idx]&&qty>0){for(let i=0;i<qty;i++){if(itemQuantityProgressData[idx][i]===true)unitsDone++;}}let itemUnitProg=qty>0?(unitsDone/qty)*100:(completedItemsIndices.includes(idx)?100:0);itemProgressPercentagesMap[idx]=itemUnitProg;calcOverallProgress+=(itemUnitProg/100)*contrib;const mr=$('<tr>').addClass('item-header-row').toggleClass('completed-item',itemUnitProg===100).attr('data-item-index',idx);mr.html(`<td>${item.category||'N/A'}</td><td>${item.item_description||'N/A'}</td><td>${item.packaging||'N/A'}</td><td style="text-align:right;">PHP ${(parseFloat(item.price||0)).toFixed(2)}</td><td style="text-align:center;">${qty}</td><td class="status-cell"><div style="display:flex;flex-direction:column;align-items:center;gap:5px;">${qty>0?`<button class="expand-units-btn btn btn-sm btn-outline-secondary py-0 px-1" onclick="toggleQuantityProgress(${idx},this)"><i class="fas fa-chevron-down"></i> Units</button>`:''}<div class="item-progress-bar-container" style="width:120px;"><div class="item-progress-bar" id="item-progress-bar-${idx}" style="width:${itemUnitProg.toFixed(0)}%;"></div><div class="item-progress-text" id="item-progress-text-${idx}">${itemUnitProg.toFixed(0)}%</div></div><div class="item-contribution-text" id="contribution-text-${idx}" style="font-size:9px;color:#666;">(Contr. ${contrib.toFixed(1)}%)</div>${qty===0?`<input type="checkbox" class="item-status-checkbox form-check-input mt-1" data-index="${idx}" onchange="updateRowStyle(this)" ${completedItemsIndices.includes(idx)?'checked':''}>`:''}</div></td>`);b.append(mr);if(qty>0){const dr=$('<tr>').addClass('units-divider').attr('id',`units-divider-${idx}`).hide().html(`<td colspan="6"></td>`);b.append(dr);for(let i=0;i<qty;i++){const uDone=itemQuantityProgressData[idx]&&itemQuantityProgressData[idx][i]===true;const ur=$('<tr>').addClass(`unit-row unit-for-item-${idx}`).hide().toggleClass('completed',uDone).html(`<td colspan="5" style="padding-left:40px;">Unit ${i+1}</td><td style="text-align:center;"><input type="checkbox" class="unit-status-checkbox form-check-input" data-item-index="${idx}" data-unit-index="${i}" onchange="updateUnitStatus(this)" ${uDone?'checked':''}></td>`);b.append(ur);}const ar=$('<tr>').addClass(`unit-row unit-action-row unit-for-item-${idx}`).hide().html(`<td colspan="6"><button class="btn btn-sm btn-outline-success py-0 px-1 me-1" onclick="selectAllUnits(${idx},${qty})">All Done</button><button class="btn btn-sm btn-outline-warning py-0 px-1" onclick="deselectAllUnits(${idx},${qty})">Reset</button></td>`);b.append(ar);}}currentOverallProgress=calcOverallProgress;updateOverallProgressDisplay();let totalOrderAmt=currentOrderItemsData.reduce((s,i)=>s+(parseFloat(i.price||0)*parseInt(i.quantity||0)),0);$('#orderTotalAmount').text(`Total: PHP ${totalOrderAmt.toFixed(2)}`);$('#overall-progress-info, .save-progress-btn').show();$('#orderDetailsModal').show();}else{showToast('Error fetching details: '+(d.message||'Unknown'),'error');}}).catch(e=>{showToast('Network error fetching details: '+e.message,'error');});}
        function viewOrderInfo(json,stat,po){try{const arr=JSON.parse(json);const b=$('#orderDetailsBody').empty();$('#status-header-cell').hide();$('#orderStatusView').text(stat+(po?` - PO: ${po}`:''));$('#orderDetailsModal .overlay-title').html(`<i class="fas fa-eye"></i> View Order Items - PO: ${po}`);let total=0;if(arr&&arr.length>0){arr.forEach(p=>{total+=(parseFloat(p.price)||0)*(parseInt(p.quantity)||0);b.append(`<tr><td>${p.category||'N/A'}</td><td>${p.item_description||'N/A'}</td><td>${p.packaging||'N/A'}</td><td style="text-align:right;">PHP ${(parseFloat(p.price)||0).toFixed(2)}</td><td style="text-align:center;">${p.quantity||0}</td><td>N/A (Status: ${stat})</td></tr>`);});}else{b.html('<tr><td colspan="6" style="text-align:center;padding:20px;">No items.</td></tr>');}$('#orderTotalAmount').text(`Total: PHP ${total.toFixed(2)}`);$('#overall-progress-info, .save-progress-btn').hide();$('#orderDetailsModal').show();}catch(e){showToast('Error displaying order info.','error');}}
        function toggleQuantityProgress(idx,btn){$(`.unit-for-item-${idx}, #units-divider-${idx}`).slideToggle(200);$(btn).find('i').toggleClass('fa-chevron-down fa-chevron-up');}
        function updateUnitStatus(cb){const itemIdx=parseInt(cb.dataset.itemIndex);const unitIdx=parseInt(cb.dataset.unitIndex);const iChk=cb.checked;$(cb).closest('tr.unit-row').toggleClass('completed',iChk);if(!currentOrderItemsData[itemIdx].quantity_progress_data)currentOrderItemsData[itemIdx].quantity_progress_data={};currentOrderItemsData[itemIdx].quantity_progress_data[unitIdx]=iChk;updateItemProgressUI(itemIdx);updateOverallProgress();}
        function updateItemProgressUI(idx){const item=currentOrderItemsData[idx];const qty=parseInt(item.quantity)||0;let progPercent=0;if(qty===0){progPercent=$(`.item-status-checkbox[data-index="${idx}"]`).is(':checked')?100:0;}else{let done=0;if(item.quantity_progress_data){for(let i=0;i<qty;i++){if(item.quantity_progress_data[i]===true)done++;}}progPercent=qty>0?(done/qty)*100:0;}item.item_progress_percentage=progPercent;$(`#item-progress-bar-${idx}`).css('width',`${progPercent.toFixed(0)}%`);$(`#item-progress-text-${idx}`).text(`${progPercent.toFixed(0)}%`);const isDone=progPercent>=99.9;$(`tr.item-header-row[data-item-index="${idx}"]`).toggleClass('completed-item',isDone);if(qty===0){const mc=$(`.item-status-checkbox[data-index="${idx}"]`);if(mc.length)mc.prop('checked',isDone);}}
        function updateOverallProgressDisplay(){const rProg=Math.round(currentOrderItemsData.overall_progress||0);$('#overall-progress-bar').css('width',`${rProg}%`).text(rProg>5?`${rProg}%`:'');$('#overall-progress-text').text(`${rProg}% Complete`);}
        function updateOverallProgress(){let newOverall=0;if(currentOrderItemsData.length>0){currentOrderItemsData.forEach((item,idx)=>{const itemProg=item.item_progress_percentage||0;const contrib=item.contribution_to_overall||(100/currentOrderItemsData.length);newOverall+=(itemProg/100)*contrib;});}currentOrderItemsData.overall_progress=newOverall;updateOverallProgressDisplay();return Math.round(newOverall);}
        function selectAllUnits(idx,qty){if(qty===0)return;$(`.unit-status-checkbox[data-item-index="${idx}"]`).prop('checked',true).closest('tr.unit-row').addClass('completed');if(!currentOrderItemsData[idx].quantity_progress_data)currentOrderItemsData[idx].quantity_progress_data={};for(let i=0;i<qty;i++)currentOrderItemsData[idx].quantity_progress_data[i]=true;updateItemProgressUI(idx);updateOverallProgress();}
        function deselectAllUnits(idx,qty){if(qty===0)return;$(`.unit-status-checkbox[data-item-index="${idx}"]`).prop('checked',false).closest('tr.unit-row').removeClass('completed');if(!currentOrderItemsData[idx].quantity_progress_data)currentOrderItemsData[idx].quantity_progress_data={};for(let i=0;i<qty;i++)currentOrderItemsData[idx].quantity_progress_data[i]=false;updateItemProgressUI(idx);updateOverallProgress();}
        function updateRowStyle(cb){const idx=parseInt(cb.dataset.index);const iChk=cb.checked;$(`tr.item-header-row[data-item-index="${idx}"]`).toggleClass('completed-item',iChk);if(!currentOrderItemsData[idx].completed_items_indices)currentOrderItemsData[idx].completed_items_indices=[];const cIdx=currentOrderItemsData[idx].completed_items_indices.indexOf(idx);if(iChk&&cIdx===-1)currentOrderItemsData[idx].completed_items_indices.push(idx);else if(!iChk&&cIdx>-1)currentOrderItemsData[idx].completed_items_indices.splice(cIdx,1);updateItemProgressUI(idx);updateOverallProgress();}
        function closeOrderDetailsModal(){$('#orderDetailsModal').hide();currentOrderItemsData=[];}
        function confirmSaveProgress(){$('#saveProgressConfirmationModal .confirmation-message').text('Save item progress for PO: '+currentPoNumber+'?');$('#saveProgressConfirmationModal').show();}
        function closeSaveProgressConfirmation(){$('#saveProgressConfirmationModal').hide();}
        function saveProgressChanges(){$('#saveProgressConfirmationModal').hide();const finalOverall=updateOverallProgress();const payload={po_number:currentPoNumber,completed_items_indices:[],quantity_progress_data:{},overall_progress:finalOverall};currentOrderItemsData.forEach((item,idx)=>{if(item.completed_items_indices&&item.completed_items_indices.includes(idx))payload.completed_items_indices.push(idx);if(item.quantity_progress_data)payload.quantity_progress_data[idx]=item.quantity_progress_data;});if(finalOverall>=100){showToast('Order 100% complete. Updating status to "For Delivery"...','info',4000);updateOrderStatus('For Delivery');}else{fetch('/backend/update_order_progress.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).then(r=>r.json()).then(d=>{if(d.success){showToast('Progress saved for PO: '+currentPoNumber,'success');setTimeout(()=>{closeOrderDetailsModal();window.location.reload();},1500);}else{showToast('Error saving progress: '+(d.message||'Unknown'),'error',5000);}}).catch(e=>{showToast('Network error saving progress: '+e.message,'error',5000);});}}
        function openEditDateModal(po,currD,ordD){currentPoNumber=po;currentEditingOrderDate=ordD;$('#edit_po_number').val(po);$('#current_delivery_date').val(currD?new Date(currD).toLocaleDateString('en-CA'):'N/A');$('#edit_order_date_display').text(ordD?new Date(ordD+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'N/A');$('#new_delivery_date_input').val('');if($.datepicker){$("#new_delivery_date_input").datepicker("destroy");let minD=new Date(ordD+'T00:00:00');minD.setDate(minD.getDate()+5);$("#new_delivery_date_input").datepicker({dateFormat:'yy-mm-dd',minDate:minD,beforeShowDay:function(dt){var day=dt.getDay();return[(day==1||day==3||day==5),''];}});}$('#editDateModal').show();}
        function closeEditDateModal(){$('#editDateModal').hide();}
        function validateEditDateForm(e){const nD=$('#new_delivery_date_input').val();if(!nD){showToast('New delivery date cannot be empty.','error');e.preventDefault();return false;}if(!isValidDeliveryDay(nD)){showToast('New delivery date must be Mon, Wed, or Fri.','error');e.preventDefault();return false;}if(!isValidDeliveryGap(currentEditingOrderDate,nD,5)){showToast('New delivery date must be at least 5 days after order date.','error',5000);e.preventDefault();return false;}return true;}
        function viewSpecialInstructions(po,instr){$('#instructionsPoNumber').text('PO: '+po);const cE=$('#instructionsContent');if(instr&&instr.trim()){cE.html(instr.replace(/\n/g,'<br>')).removeClass('empty');}else{cE.text('No special instructions.').addClass('empty');}$('#specialInstructionsModal').show();}
        function closeSpecialInstructions(){$('#specialInstructionsModal').hide();}
        function initializeDeliveryDatePickerForAddOrder(base){const dIn=$("#delivery_date_input");if($.datepicker&&dIn.length){dIn.datepicker("destroy");const min=getNextAvailableDeliveryDate(base,5);dIn.datepicker({dateFormat:'yy-mm-dd',minDate:min,beforeShowDay:function(dt){var day=dt.getDay();return[(day==1||day==3||day==5),''];}});if(!dIn.val()){dIn.datepicker("setDate",min);}}}
        function fetchAndSetWalkInPONumber(){$('#po_number_for_submit').val('Generating...');fetch('/backend/get_next_walkin_po.php').then(r=>r.json()).then(d=>{if(d.success&&typeof d.next_sequence_number!=='undefined'){const po=`WI-${String(d.next_sequence_number).padStart(3,'0')}`;$('#po_number_for_submit').val(po);}else{throw new Error(d.message||'Invalid PO data.');}}).catch(e=>{showToast('Error generating Walk-In PO: '+e.message,'error');$('#po_number_for_submit').val('');});}
        function toggleOrderFormFields(){const type=$('#order_type_selection').val();$('#order_type_hidden_for_submit').val(type);$('#onlineSpecificInputs,#walkInSpecificInputs,#commonOrderFields,#confirmAddOrderBtn').hide();$('#delivery_date_form_group,#delivery_address_type_form_group,#company_address_container_div,#custom_address_container_div').hide();$('#username_online_select').val('');$('#online_company_display').val('');$('#walk_in_name_company_input').val('');$('#delivery_date_input').val('');$('#custom_address_input_field').val('');$('#delivery_address_for_submit').val('');$('#po_number_for_submit').val('');if(type==="Online"){$('#onlineSpecificInputs,#commonOrderFields,#confirmAddOrderBtn').show();$('#delivery_date_form_group,#delivery_address_type_form_group').show();$('#company_address_option_for_delivery').show();$('#delivery_address_type_select').val('company');handleOnlineUserChange();}else if(type==="Walk In"){$('#walkInSpecificInputs,#commonOrderFields,#confirmAddOrderBtn').show();$('#custom_address_label').text('Address (Walk-In):');$('#custom_address_container_div').show();$('#delivery_address_type_select').val('custom');fetchAndSetWalkInPONumber();$('#company_name_final_for_submit').val('');}if(type){const today=new Date();const fmtToday=`${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2,'0')}-${today.getDate().toString().padStart(2,'0')}`;$('#order_date_input').val(fmtToday);if(type==="Online"){initializeDeliveryDatePickerForAddOrder(fmtToday);}}currentCartItems=[];updateOrderSummary();updateCartItemCount();toggleDeliveryAddressOptions();}
        function handleOnlineUserChange(){const opt=$('#username_online_select option:selected');const user=opt.val();if(user){const comp=opt.data('company')||'N/A';const addr=opt.data('company-address')||'';$('#online_company_display').val(comp);$('#company_name_final_for_submit').val(comp);$('#company_address_display_field').val(addr);if($('#delivery_address_type_select').val()==='company')$('#delivery_address_for_submit').val(addr);$('#po_number_for_submit').val(generateOnlinePONumber(user));}else{$('#online_company_display,#company_name_final_for_submit,#company_address_display_field,#po_number_for_submit').val('');if($('#delivery_address_type_select').val()==='company')$('#delivery_address_for_submit').val('');}}
        function toggleDeliveryAddressOptions(){const type=$('#delivery_address_type_select').val();const orderType=$('#order_type_selection').val();if(orderType==="Walk In"){$('#company_address_container_div').hide();$('#custom_address_container_div').show();$('#delivery_address_for_submit').val($('#custom_address_input_field').val().trim());return;}if(type==='company'){$('#company_address_container_div').show();$('#custom_address_container_div').hide();$('#delivery_address_for_submit').val($('#company_address_display_field').val());}else{$('#company_address_container_div').hide();$('#custom_address_container_div').show();$('#delivery_address_for_submit').val($('#custom_address_input_field').val().trim());}}
        $('#custom_address_input_field').on('input',function(){const orderType=$('#order_type_selection').val();if(orderType==="Walk In"||$('#delivery_address_type_select').val()==='custom'){$('#delivery_address_for_submit').val($(this).val().trim());}});
        function openAddOrderForm(){$('#addOrderForm')[0].reset();currentCartItems=[];updateOrderSummary();updateCartItemCount();$('#order_type_selection').val("").trigger('change');$('#onlineSpecificInputs,#walkInSpecificInputs,#commonOrderFields,#confirmAddOrderBtn').hide();$('#delivery_date_form_group,#delivery_address_type_form_group,#company_address_container_div,#custom_address_container_div').hide();$('#addOrderOverlay').show();}
        function closeAddOrderForm(){$('#addOrderOverlay').hide();}
        function generateOnlinePONumber(user){if(!user)return '';const d=new Date();const uPart=user.substring(0,Math.min(user.length,4)).toUpperCase();const po=`PO-${uPart}-${d.getFullYear().toString().slice(-2)}${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}-${d.getHours().toString().padStart(2,'0')}${d.getMinutes().toString().padStart(2,'0')}-${Math.floor(100+Math.random()*900)}`;return po;}
        function prepareOrderDataForSubmit(){const type=$('#order_type_selection').val();$('#order_type_hidden_for_submit').val(type);if(!type){showToast('Please select Order Type.','error');return false;}let user='',comp='';if(type==="Online"){user=$('#username_online_select').val();if(!user){showToast('Select Client Username for Online order.','error');return false;}comp=$('#online_company_display').val();const dDate=$('#delivery_date_input').val();const oDate=$('#order_date_input').val();if(!dDate){showToast('Delivery Date required for Online.','error');return false;}if(!isValidDeliveryDay(dDate)){showToast('Delivery date must be Mon, Wed, or Fri.','error');return false;}if(!isValidDeliveryGap(oDate,dDate,5)){showToast('Delivery date must be 5+ days after order date.','error',5000);return false;}}else if(type==="Walk In"){user='Walk-In Customer';comp=$('#walk_in_name_company_input').val().trim();if(!comp){showToast('Full Name/Company required for Walk-In.','error');return false;}}$('#company_name_final_for_submit').val(comp);if(currentCartItems.length===0){showToast('Order cannot be empty.','error');return false;}$('#orders_json_for_submit').val(JSON.stringify(currentCartItems));let total=0;currentCartItems.forEach(i=>{total+=(parseFloat(i.price)||0)*(parseInt(i.quantity)||0);});$('#total_amount_for_submit').val(total.toFixed(2));const addr=$('#delivery_address_for_submit').val().trim();if(!addr){showToast(`${type==="Walk In"?"Address (Walk-In)":"Custom Delivery Address"} required.`,'error');return false;}if(!$('#po_number_for_submit').val()||($('#po_number_for_submit').val()==='Generating...')){showToast('PO Number not generated.','error');return false;}return true;}
        function confirmAddOrder(){if(prepareOrderDataForSubmit()){$('#addConfirmationModal .confirmation-message').text('Submit this order?');$('#addConfirmationModal').show();}}
        function closeAddConfirmation(){$('#addConfirmationModal').hide();}
        function submitAddOrder(){$('#addConfirmationModal').hide();if(!prepareOrderDataForSubmit())return;const formEl=document.getElementById('addOrderForm');const fd=new FormData(formEl);const oType=fd.get('order_type');if(oType==="Walk In"){fd.delete('username_online');fd.delete('delivery_date');}fetch('/backend/add_order.php',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{if(d.success){showToast('Order added! PO: '+(d.po_number||fd.get('po_number')),'success',4000);const uEmail=oType==="Online"?fd.get('username_online'):'Walk-In Client';sendNewOrderEmail(uEmail,d.po_number||fd.get('po_number'));if(d.recommend_pending){showToast('Order created as Pending due to insufficient raw materials.','warning',6000);}setTimeout(()=>window.location.href='orders.php',oType==="Online"&&d.recommend_pending?3000:2000);}else{showToast('Error adding order: '+(d.message||'Unknown server error.'),'error',5000);}}).catch(e=>{showToast('Network error adding order: '+e.message,'error',5000);});}
        function sendNewOrderEmail(user,po){fetch('/backend/send_new_order_notification.php',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded',},body:`username=${encodeURIComponent(user)}&po_number=${encodeURIComponent(po)}`}).then(r=>r.json()).then(d=>{console.log(d.success?"New order email sent.":"New order email failed: "+d.message);}).catch(e=>console.error("New order email AJAX error:",e));}
        function openInventoryOverlay(){$('#inventoryOverlay').show();const invBody=$('.inventory').html('<tr><td colspan="6" style="text-align:center;padding:20px;"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Loading...</p></td></tr>');fetch('/backend/get_inventory.php').then(r=>r.json()).then(d=>{if(d.success&&d.inventory){populateInventoryTable(d.inventory);populateCategoryFilter(d.categories||[]);}else{invBody.html('<tr><td colspan="6" style="text-align:center;padding:20px;color:red;">Error: '+(d.message||'No data.')+'</td></tr>');showToast('Error loading inventory: '+(d.message||'Unknown'),'error');}}).catch(e=>{invBody.html('<tr><td colspan="6" style="text-align:center;padding:20px;color:red;">Failed: '+e.message+'</td></tr>');showToast('Failed to load inventory: '+e.message,'error');});}
        function populateInventoryTable(items){const b=$('.inventory').empty();if(!items||items.length===0){b.html('<tr><td colspan="6" style="text-align:center;padding:20px;">No products.</td></tr>');return;}items.forEach(i=>{const p=parseFloat(i.price);if(isNaN(p)||i.product_id===undefined)return;b.append(`<tr><td>${i.category||'N/A'}</td><td>${i.item_description||'N/A'}</td><td>${i.packaging||'N/A'}</td><td style="text-align:center;">PHP ${p.toFixed(2)}</td><td style="text-align:center;"><input type="number" class="inventory-quantity form-control form-control-sm" value="1" min="1" max="100" style="width:70px;margin:auto;"></td><td style="text-align:center;"><button class="add-to-cart-btn btn btn-primary btn-sm" onclick="addToCartFromInventory(this,'${i.product_id}','${i.category||''}','${i.item_description||''}','${i.packaging||''}',${p})"><i class="fas fa-cart-plus"></i> Add</button></td></tr>`);});}
        function populateCategoryFilter(cats){const sel=$('#inventoryFilter');sel.find('option:not(:first-child)').remove();if(!cats||cats.length===0)return;cats.forEach(c=>sel.append(`<option value="${c}">${c}</option>`));}
        function filterInventory(){const cat=$('#inventoryFilter').val();const term=$('#inventorySearch').val().toLowerCase().trim();$('.inventory tr').each(function(){const r=$(this);const rCat=r.find('td:first-child').text();const rTxt=r.text().toLowerCase();const cMatch=(cat==='all'||rCat===cat);const sMatch=(term===''||rTxt.includes(term));r.toggle(cMatch&&sMatch);});}
        $('#inventorySearch, #inventoryFilter').off('input change',filterInventory).on('input change',filterInventory);
        function closeInventoryOverlay(){$('#inventoryOverlay').hide();}
        function addToCartFromInventory(btn,pid,cat,desc,pack,price){const qIn=$(btn).closest('tr').find('.inventory-quantity');let qty=parseInt(qIn.val());if(isNaN(qty)||qty<1){showToast('Qty must be >= 1.','error');qIn.val(1);return;}if(qty>100){showToast('Max qty is 100.','error');qty=100;qIn.val(100);}const exIdx=currentCartItems.findIndex(i=>String(i.product_id)===String(pid)&&i.packaging===pack);if(exIdx>=0){let newTotal=currentCartItems[exIdx].quantity+qty;if(newTotal>100){showToast(`Cannot add ${qty}. Total for ${desc} would exceed 100.`,'warning',4000);return;}else{currentCartItems[exIdx].quantity=newTotal;}}else{currentCartItems.push({product_id:pid,category:cat,item_description:desc,packaging:pack,price:parseFloat(price),quantity:qty});}showToast(`${qty} x ${desc} added.`,'success');qIn.val(1);updateOrderSummary();updateCartItemCount();}
        function updateOrderSummary(){const sumBody=$('#summaryBody').empty();let total=0;if(currentCartItems.length===0){sumBody.html('<tr><td colspan="6" style="text-align:center;padding:15px;">No products selected.</td></tr>');$('#orderSummaryItemCount').text('(0 items)');}else{currentCartItems.forEach((item,idx)=>{total+=(item.price||0)*(item.quantity||0);sumBody.append(`<tr><td>${item.category}</td><td>${item.item_description}</td><td>${item.packaging}</td><td style="text-align:right;">PHP ${(parseFloat(item.price||0)).toFixed(2)}</td><td style="text-align:center;"><input type="number" class="cart-quantity summary-quantity form-control form-control-sm" value="${item.quantity}" min="1" max="100" data-cart-item-index="${idx}" onchange="updateSummaryItemQuantity(this)" style="width:70px;margin:auto;"></td><td style="text-align:center;"><button class="remove-item-btn btn btn-danger btn-sm" onclick="removeSummaryItem(${idx})"><i class="fas fa-trash-alt"></i></button></td></tr>`);});$('#orderSummaryItemCount').text(`(${currentCartItems.length} item${currentCartItems.length===1?'':'s'})`);}$('.summary-total-amount').text(`PHP ${total.toFixed(2)}`);$('#total_amount_for_submit').val(total.toFixed(2));}
        function updateSummaryItemQuantity(el){const idx=parseInt($(el).data('cart-item-index'));let qty=parseInt($(el).val());if(isNaN(qty)||qty<1){showToast('Qty must be >= 1.','error');$(el).val(currentCartItems[idx].quantity);return;}if(qty>100){showToast('Max qty 100.','error');qty=100;$(el).val(100);}currentCartItems[idx].quantity=qty;updateOrderSummary();updateCartItemCount();updateCartDisplay();}
        function removeSummaryItem(idx){if(idx>=0&&idx<currentCartItems.length){const rem=currentCartItems.splice(idx,1)[0];showToast(`Removed ${rem.item_description}.`,'info');updateOrderSummary();updateCartItemCount();updateCartDisplay();}}
        function updateCartItemCount(){const c=currentCartItems.length;$('#cartItemCountNav').text(c);$('#orderSummaryItemCount').text(`(${c} item${c===1?'':'s'})`);if(c===0)$('#orderSummaryItemCount').text('(0 items)');}
        window.openCartModal=function(){$('#cartModal').show();updateCartDisplay();}
        function closeCartModal(){$('#cartModal').hide();}
        function saveCartChangesAndClose(){updateOrderSummary();closeCartModal();showToast('Items confirmed.','success');}
        function updateCartDisplay(){const cartBody=$('.cart').empty();const noProdRow=$('.no-products-in-cart-row');const totalEl=$('.total-amount-cart');let total=0;if(currentCartItems.length===0){if(noProdRow.length)noProdRow.show();else cartBody.html('<tr class="no-products-in-cart-row"><td colspan="6" style="text-align:center;padding:20px;">No products selected.</td></tr>');totalEl.text('PHP 0.00');}else{if(noProdRow.length)noProdRow.hide();currentCartItems.forEach((item,idx)=>{total+=(item.price||0)*(item.quantity||0);cartBody.append(`<tr><td>${item.category}</td><td>${item.item_description}</td><td>${item.packaging}</td><td style="text-align:center;">PHP ${(parseFloat(item.price)||0).toFixed(2)}</td><td style="text-align:center;"><input type="number" class="cart-quantity form-control form-control-sm" value="${item.quantity}" min="1" max="100" data-cart-item-index="${idx}" onchange="updateCartModalItemQuantity(this)" style="width:70px;margin:auto;"></td><td style="text-align:center;"><button class="remove-item-btn btn btn-danger btn-sm" onclick="removeCartModalItem(${idx})"><i class="fas fa-trash-alt"></i></button></td></tr>`);});totalEl.text(`PHP ${total.toFixed(2)}`);}}
        function updateCartModalItemQuantity(el){const idx=parseInt($(el).data('cart-item-index'));let qty=parseInt($(el).val());if(isNaN(qty)||qty<1){showToast('Qty >= 1.','error');$(el).val(currentCartItems[idx].quantity);return;}if(qty>100){showToast('Max 100.','error');qty=100;$(el).val(100);}currentCartItems[idx].quantity=qty;updateCartDisplay();updateOrderSummary();}
        function removeCartModalItem(idx){if(idx>=0&&idx<currentCartItems.length){const rem=currentCartItems.splice(idx,1)[0];showToast(`Removed ${rem.item_description}.`,'info');updateCartDisplay();updateOrderSummary();updateCartItemCount();}}
        
        $(document).ready(function(){setTimeout(function(){$(".alert").fadeOut("slow");},3500);$("#searchInput").on("keyup input",function(){const term=$(this).val().toLowerCase().trim();$(".orders-table tbody tr").each(function(){const rowTxt=$(this).text().toLowerCase();$(this).toggle(rowTxt.includes(term));});});$('#order_type_selection').val("");$('#onlineSpecificInputs,#walkInSpecificInputs,#commonOrderFields,#delivery_date_form_group,#delivery_address_type_form_group,#company_address_container_div,#custom_address_container_div').hide();$(document).on('click',function(e){const $t=$(e.target);if($t.hasClass('overlay')||$t.hasClass('modal')||$t.hasClass('instructions-modal')||$t.hasClass('confirmation-modal')){if(e.target===e.currentTarget){if($t.is('#addOrderOverlay:visible'))closeAddOrderForm();else if($t.is('#inventoryOverlay:visible'))closeInventoryOverlay();else if($t.is('#cartModal:visible'))closeCartModal();else if($t.is('#orderDetailsModal:visible'))closeOrderDetailsModal();else if($t.is('#pdfPreview:visible'))closePDFPreview();else if($t.is('#statusModal:visible'))closeStatusModal();else if($t.is('#pendingStatusModal:visible'))closePendingStatusModal();else if($t.is('#rejectedStatusModal:visible'))closeRejectedStatusModal();else if($t.is('#editDateModal:visible'))closeEditDateModal();else if($t.is('#specialInstructionsModal:visible'))closeSpecialInstructions();else if($t.hasClass('confirmation-modal'))$t.hide();}}});});
    </script>
</body>
</html>